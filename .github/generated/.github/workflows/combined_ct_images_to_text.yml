name: MorphoSource Analysis Workflow

on:
  workflow_dispatch:
  workflow_run:
    workflows: ["Parse MorphoSource Data"]
    types: [completed]

jobs:
  check_and_analyze:
    runs-on: ubuntu-22.04
    outputs:
      is_morphosource: ${{ steps.check_morpho.outputs.is_morphosource }}
      has_analysis: ${{ steps.check_existing.outputs.has_analysis }}
      release_body: ${{ steps.fetch_release.outputs.release_body }}
      release_tag: ${{ steps.fetch_release.outputs.release_tag }}
    steps:
      # ... (existing steps) ...

  url_check:
    needs: check_and_analyze
    if: |
      needs.check_and_analyze.outputs.is_morphosource == 'true' &&
      needs.check_and_analyze.outputs.has_analysis != 'true'
    runs-on: ubuntu-22.04
    outputs:
      has_media_error: ${{ steps.url_check.outputs.has_media_error }}
      has_server_error: ${{ steps.url_check.outputs.has_server_error }}
      has_no_file_error: ${{ steps.url_check.outputs.has_no_file_error }}
      has_mesh: ${{ steps.type_check.outputs.has_mesh }}
      has_volumetric_images: ${{ steps.type_check.outputs.has_volumetric_images }}
    steps:
      # ... (existing steps) ...

      - name: Run URL check
        id: url_check
        run: |
          python .github/scripts/url_screenshot_check.py release_body.txt || true
          
          if [ -f "url_check_status.json" ]; then
            status=$(cat url_check_status.json | jq -r .status)
            if [ "$status" = "media_error" ]; then
              echo "has_media_error=true" >> "$GITHUB_OUTPUT"
              echo "has_server_error=false" >> "$GITHUB_OUTPUT"
              echo "has_no_file_error=false" >> "$GITHUB_OUTPUT"
            elif [ "$status" = "server_error" ]; then
              echo "has_media_error=false" >> "$GITHUB_OUTPUT"
              echo "has_server_error=true" >> "$GITHUB_OUTPUT"
              echo "has_no_file_error=false" >> "$GITHUB_OUTPUT"
            elif [ "$status" = "no_file_uploaded" ]; then
              echo "has_media_error=false" >> "$GITHUB_OUTPUT"
              echo "has_server_error=false" >> "$GITHUB_OUTPUT"
              echo "has_no_file_error=true" >> "$GITHUB_OUTPUT"
            else
              echo "has_media_error=false" >> "$GITHUB_OUTPUT"
              echo "has_server_error=false" >> "$GITHUB_OUTPUT"
              echo "has_no_file_error=false" >> "$GITHUB_OUTPUT"
            fi
          else
            echo "has_media_error=false" >> "$GITHUB_OUTPUT"
            echo "has_server_error=false" >> "$GITHUB_OUTPUT"
            echo "has_no_file_error=false" >> "$GITHUB_OUTPUT"
          fi

      # ... (existing steps) ...

  # ... (existing jobs) ...

  handle_errors:
    needs: [check_and_analyze, url_check, process_3d, process_2d]
    if: |
      always() && 
      needs.check_and_analyze.outputs.is_morphosource == 'true' &&
      (failure() || 
       needs.url_check.outputs.has_media_error == 'true' || 
       needs.url_check.outputs.has_server_error == 'true' ||
       needs.url_check.outputs.has_no_file_error == 'true')
    runs-on: ubuntu-22.04
    steps:
      - name: Check for Existing Error Release
        id: check_error
        env:
          GITHUB_TOKEN: ${{ secrets.MY_GITHUB_TOKEN }}
        run: |
          # Get the morphosource release tag
          MS_TAG="${{ needs.check_and_analyze.outputs.release_tag }}"
          
          # Check for existing error releases for this morphosource release
          response=$(curl -sSL -H "Authorization: Bearer $GITHUB_TOKEN" \
            "https://api.github.com/repos/${{ github.repository }}/releases?per_page=100")
          
          has_error=$(echo "$response" | jq -r "
            [.[] | 
            select(
              (.tag_name | startswith(\"ct_analysis_error-\")) and
              (.body | contains(\"$MS_TAG\"))
            )] | length")
            
          if [ "$has_error" -gt "0" ]; then
            echo "Error release already exists for $MS_TAG"
            echo "skip=true" >> "$GITHUB_OUTPUT"
          else
            echo "No existing error release found for $MS_TAG"
            echo "skip=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Create Error Release
        if: steps.check_error.outputs.skip != 'true'
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.MY_GITHUB_TOKEN }}
        with:
          tag_name: "ct_analysis_error-${{ github.run_id }}"
          release_name: "CT Analysis Error #${{ github.run_id }}"
          body: |
            Error occurred during analysis of MorphoSource release: ${{ needs.check_and_analyze.outputs.release_tag }}
            
            Status:
            - Media Error: ${{ needs.url_check.outputs.has_media_error }}
            - Server Error: ${{ needs.url_check.outputs.has_server_error }}
            - No File Uploaded Error: ${{ needs.url_check.outputs.has_no_file_error }}
            - 3D Process: ${{ needs.process_3d.result }}
            - 2D Process: ${{ needs.process_2d.result }}

      # ... (existing steps) ...

      - name: Set Error Status
        if: steps.check_error.outputs.skip != 'true'
        run: |
          if [ "${{ needs.url_check.outputs.has_media_error }}" == "true" ] || \
             [ "${{ needs.url_check.outputs.has_server_error }}" == "true" ] || \
             [ "${{ needs.url_check.outputs.has_no_file_error }}" == "true" ]; then
            echo "Media, Server or No File Uploaded error occurred - marking as completed to prevent loops"
            exit 0
          fi
          
          if [ "${{ needs.process_3d.result }}" == "success" ] || [ "${{ needs.process_2d.result }}" == "success" ]; then
            echo "Analysis completed successfully"
            exit 0
          else
            echo "Analysis failed"
            exit 1
          fi