# CT to Text API Release Support

## Overview

The CT to Text workflow (`ct_to_text.yml`) now supports analyzing both traditional MorphoSource releases and API-based releases that contain JSON data.

## Background

Previously, the workflow only processed releases with "New Record #" formatted entries. The MorphoSource API releases include JSON data in markdown code blocks, which was causing issues:

1. **Security Issue**: Using `echo` to write release bodies caused bash to interpret JSON fields as commands
2. **Parsing Issue**: The script didn't recognize or parse JSON-based releases

## Solution

### Workflow Changes

**Command Injection Fix**:
```yaml
# Before (unsafe):
echo "${{ steps.fetch_release.outputs.release_body }}" > temp_release.txt

# After (safe):
# In fetch_release step:
echo "$release" | jq -r .body > release_body.txt

# In subsequent steps, use the file instead of interpolating the variable:
# OLD: printf '%s\n' "${{ steps.fetch_release.outputs.release_body }}" > temp_release.txt
# NEW: (use release_body.txt directly - already created in fetch_release step)
```

The fix works by writing the release body to a file immediately after fetching it, before any GitHub Actions variable interpolation can cause issues. All subsequent steps read from this file instead of interpolating the release body variable, preventing bash from ever seeing JSON content as commands.

**API Release Detection**:
```yaml
# Check if release body contains "New Record #" entries OR JSON API data
if grep -q "^New Record #[0-9]" temp_release.txt; then
  echo "has_records=true" >> "$GITHUB_OUTPUT"
elif grep -q "### Full API JSON for latest record" temp_release.txt; then
  echo "has_records=true" >> "$GITHUB_OUTPUT"
else
  echo "has_records=false" >> "$GITHUB_OUTPUT"
fi
```

### Script Changes

The `ct_to_text.py` script now includes:

1. **JSON Extraction**: Extracts JSON from markdown code blocks
2. **API Release Detection**: Identifies releases with "### Full API JSON for latest record"
3. **API Record Parsing**: Parses both the markdown metadata and JSON data
4. **Enhanced ChatGPT Prompts**: Includes API JSON fields in the analysis request

## Usage

### Traditional Release Format

```markdown
New Record #123456 Title: Skull [Mesh] [CT]
Detail Page URL: https://www.morphosource.org/concern/media/123456
Object: M-12345
Taxonomy: Homo sapiens
...
```

### API Release Format

```markdown
## Latest record (from this API page)
- **id:** `000620417`
- **title:** Head, Mouthparts, Prosoma [CTImageSeries] [CT]
- **detail page:** https://www.morphosource.org/concern/media/000620417

### Full API JSON for latest record
```json
{
  "id": "000620417",
  "title_tesim": ["Head, Mouthparts, Prosoma [CTImageSeries] [CT]"],
  "media_type_tesim": ["3d image"],
  ...
}
```
```

Both formats are automatically detected and processed correctly.

## API JSON Fields Included in Analysis

When processing API releases, the following JSON fields are extracted and sent to ChatGPT:

- `title_tesim` - Record title
- `media_type_tesim` - Media type (e.g., "3d image")
- `date_uploaded_dtsi` - Upload timestamp
- `date_modified_dtsi` - Modification timestamp
- All other non-internal fields

**Excluded fields** (internal/technical):
- Fields starting with `system_`, `has_`, or `is`
- `id`, `accessControl_ssim`, `depositor_ssim`, `depositor_tesim`

## Output Format

The CT to Text Analysis release includes:

1. **Record Metadata**: Record number, title, and detail page URL
2. **AI Analysis**: Scientific description generated by ChatGPT

Example output:

```markdown
## Record #000620417
**Title:** Head, Mouthparts, Prosoma [CTImageSeries] [CT]
**Detail Page:** https://www.morphosource.org/concern/media/000620417

## Analysis
This is a fascinating CT scan of an arachnid specimen...
```

## Testing

The changes have been tested with:

1. Traditional releases (backward compatibility)
2. API releases with JSON data
3. Malformed JSON handling
4. Empty/invalid releases
5. Command injection prevention

All tests pass successfully.

## Security

This update fixes a **high priority** security issue by preventing command injection through crafted release bodies. The `printf` command ensures that all content is treated as literal text, not as shell commands.

## Performance

The JSON parsing adds minimal overhead and only occurs when API releases are detected. Traditional releases continue to use the original fast parsing logic.
